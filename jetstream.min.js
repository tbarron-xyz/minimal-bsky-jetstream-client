export class Jetstream{endpoint="jetstream1.us-east.bsky.network";emitters=new Map;ws=null;get url(){const t=new URL(`wss://${this.endpoint}/subscribe`);for(const e of this.emitters.keys())t.searchParams.append("wantedCollections",e);return t.toString()}constructor(t={}){this.endpoint=t.endpoint??this.endpoint}#t(t,e,s){const n=this.emitters.get(t)||new EventTarget;this.emitters.set(t,n),n.addEventListener(e,s)}onCreate(t,e){this.#t(t,"create",e)}onUpdate(t,e){this.#t(t,"update",e)}onDelete(t,e){this.#t(t,"delete",e)}start(){this.stop(),this.ws=new WebSocket(this.url),this.ws.onmessage=t=>{const e=JSON.parse(t.data);if("commit"!==e.kind)return;const s=this.emitters.get(e.commit.collection);s&&s.dispatchEvent(new CustomEvent(e.commit.operation,e))}}stop(){this.ws&&this.ws.close()}onTweet(t){this.onCreate("app.bsky.feed.post",t)}}
